name: CI/CD Testing

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            docker-compose.yml
            docker-compose.traefik.yml
            .github/workflows/*.yml
          config_file: .yamllint.yml
          strict: false

      - name: Validate docker-compose syntax
        run: |
          echo "üîç Validating docker-compose files..."
          docker compose -f docker-compose.traefik.yml config > /dev/null
          docker compose -f docker-compose.yml config > /dev/null
          echo "‚úÖ Docker compose files are valid"

      - name: ShellCheck bash scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning

      - name: Check for secrets in code
        run: |
          echo "üîç Scanning for potential secrets..."

          # Check for common secret patterns
          if grep -rE "(password|secret|token|api_key)\s*=\s*['\"][^'\"]+['\"]" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude="*.md" \
            .; then
            echo "‚ö†Ô∏è Potential secrets found in code!"
            exit 1
          fi

          echo "‚úÖ No secrets found in code"

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: lint-and-validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test environment file
        run: |
          cat > .env << EOF
          ODOO_VERSION=19.0
          DOMAIN=test.localhost
          POSTGRES_DB=odoo
          POSTGRES_USER=odoo
          POSTGRES_PASSWORD=test_password_123
          DB_HOST=db
          ACME_EMAIL=test@example.com
          TRAEFIK_DASHBOARD_AUTH=test:test
          TZ=America/Bogota
          EOF

      - name: Create traefik network
        run: docker network create traefik-network

      - name: Test Traefik compose
        run: |
          echo "üß™ Testing Traefik deployment..."
          docker compose -f docker-compose.traefik.yml up -d
          sleep 10

          # Check if Traefik is running
          if docker ps | grep -q traefik; then
            echo "‚úÖ Traefik started successfully"
          else
            echo "‚ùå Traefik failed to start"
            docker compose -f docker-compose.traefik.yml logs
            exit 1
          fi

      - name: Test Odoo compose
        run: |
          echo "üß™ Testing Odoo deployment..."
          docker compose up -d

          # Wait for services
          echo "‚è≥ Waiting for services to initialize..."
          sleep 30

          # Check if services are running
          if docker ps | grep -q odoo_app && docker ps | grep -q odoo_db; then
            echo "‚úÖ Services started successfully"
          else
            echo "‚ùå Services failed to start"
            docker compose logs
            exit 1
          fi

      - name: Test database connectivity
        run: |
          echo "üß™ Testing database connectivity..."

          # Wait for DB to be ready
          timeout 60 bash -c 'until docker exec odoo_db pg_isready -U odoo; do sleep 2; done'

          if docker exec odoo_db psql -U odoo -c "SELECT 1;" > /dev/null 2>&1; then
            echo "‚úÖ Database is accessible"
          else
            echo "‚ùå Database connection failed"
            exit 1
          fi

      - name: Test Odoo service
        run: |
          echo "üß™ Testing Odoo service..."

          # Wait for Odoo to be ready
          sleep 30

          if docker exec odoo_app curl -f http://localhost:8069/web/database/selector > /dev/null 2>&1; then
            echo "‚úÖ Odoo service is responding"
          else
            echo "‚ö†Ô∏è Odoo service may not be fully ready (this is normal for first startup)"
          fi

      - name: Show container status
        if: always()
        run: |
          echo "üìä Container Status:"
          docker ps -a
          echo ""
          echo "üìä Container Logs:"
          docker compose logs --tail=50

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker compose -f docker-compose.traefik.yml down -v
          docker network rm traefik-network || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for table output
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  check-documentation:
    name: Check Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          required_docs=("README.md" "DEPLOYMENT.md" "CLAUDE.md")

          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing required documentation: $doc"
              exit 1
            fi
          done

          echo "‚úÖ All required documentation present"

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

  test-scripts:
    name: Test Shell Scripts
    runs-on: ubuntu-latest
    needs: lint-and-validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test setup-env.sh
        run: |
          echo "üß™ Testing setup-env.sh..."
          # Dry run test - check syntax
          bash -n setup-env.sh
          echo "‚úÖ setup-env.sh syntax is valid"

      - name: Test validate.sh
        run: |
          echo "üß™ Testing validate.sh..."
          bash -n validate.sh
          echo "‚úÖ validate.sh syntax is valid"

      - name: Test Makefile targets
        run: |
          echo "üß™ Testing Makefile..."
          make help
          echo "‚úÖ Makefile is functional"

  test-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [lint-and-validate, test-docker-build, security-scan, check-documentation, test-scripts]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "üìä CI/CD Test Results Summary"
          echo "=============================="
          echo "Lint and Validate: ${{ needs.lint-and-validate.result }}"
          echo "Docker Build Test: ${{ needs.test-docker-build.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Documentation Check: ${{ needs.check-documentation.result }}"
          echo "Script Tests: ${{ needs.test-scripts.result }}"

          if [[ "${{ needs.lint-and-validate.result }}" == "success" ]] && \
             [[ "${{ needs.test-docker-build.result }}" == "success" ]] && \
             [[ "${{ needs.security-scan.result }}" == "success" ]] && \
             [[ "${{ needs.check-documentation.result }}" == "success" ]] && \
             [[ "${{ needs.test-scripts.result }}" == "success" ]]; then
            echo ""
            echo "‚úÖ All tests passed successfully!"
            exit 0
          else
            echo ""
            echo "‚ùå Some tests failed. Please review the logs."
            exit 1
          fi
